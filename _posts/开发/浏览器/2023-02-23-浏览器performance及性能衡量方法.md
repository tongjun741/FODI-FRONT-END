---
tags:
    - 浏览器
---

在前端监控中，会统计页面相关的性能指标数据，如：DNS解析耗时、TCP连接耗时、DOM解析耗时、首包时间等等。刚接触前端监控的同学会提出很多问题，这些性能指标数据是如何获取的、计算的方式是怎样的、如何根据统计的数据做性能优化？下面会针对这些问题做一个详细介绍。

## performance

window.performance 是W3C规范提供的接口，可以通过它获取到用户访问一个页面的每个阶段的精确时间(timestamp),从而对性能进行分析。

其中performance.timing包含的统计字段如下图，由于是浏览器直接实现，相对于js通过Date手动分析、cookie分析网页时间要精确很多。



![img](/img-post/开发/浏览器/浏览器性能performance及性能衡量方法.assets/v2-765a986f7317150d990e5bf5d3fdb2ac_1440w.jpg)



各阶段的API见下图：



![img](/img-post/开发/浏览器/浏览器性能performance及性能衡量方法.assets/v2-cca5e141117533c8c9c4ab84eb0edd35_1440w.jpg)



每个字段的具体含义这里不展开介绍，具体可以看[W3C对应文档](https://link.zhihu.com/?target=https%3A//www.w3.org/TR/navigation-timing/%23performancetiming)。

## 性能指标

1. DNS解析耗时: domainLookupEnd - domainLookupStart
2. TCP连接耗时: connectEnd - connectStart
3. SSL安全连接耗时: connectEnd - secureConnectionStart
4. 网络请求耗时(TTFB): responseStart - requestStart
5. 数据传输耗时: responseEnd - responseStart
6. DOM解析耗时: domInteractive - responseEnd
7. 资源加载耗时: loadEventStart - domContentLoadedEventEnd
8. 首包时间: responseStart - domainLookupStart
9. 首次渲染时间 / 白屏时间: responseEnd - fetchStart
10. 首次可交互时间: domInteractive - fetchStart
11. DOM Ready时间: domContentLoadEventEnd - fetchStart
12. 页面完全加载时间: loadEventStart - fetchStart

## 性能统计

现在利用performance可以获取到每个阶段的耗时数据，但是不同的人在不同的环境、不同的时间访问同一页面时，统计到的时间是不同的，如网络较差的环境打开页面的耗时较长，凌晨访问量较小且网络环境好的情况下打开页面的耗时较少。

要想知道该页面的整体性能，需要对统计到的数据做一个处理，使得用户可以对页面性能有一个直观的认识，为用户页面性能调优提供依据。

如何利用这些数据衡量自己应用的性能情况呢？这里介绍几种统计方法：

## 1.平均值统计法

在前端性能监控中，衡量性能情况的一种常用方法即：平均值统计法。收集到一段时间区间中所有用户访问应用的性能数据，将这些数据做均值处理，最终给到这个时间区间的平均耗时数据。



![img](/img-post/开发/浏览器/浏览器性能performance及性能衡量方法.assets/v2-8c925e5bcea6731a37b49a5ea3574804_1440w.jpg)



这种统计方法简单粗暴，其中长尾数据很大程度上会影响均值的大小，导致给出的均值无法很好的表现性能情况；同时性能数据分布情况不清楚，无法制定优化方案。

## 2.百分位数统计法

百分位数则是对应于百分位的实际数值，比如第60百分位数：将数据从小到大排列，处于第60%的数据称为60分位数, 表示60%的性能数据均小于等于该值，那剩下的40%的数据均大于等于该值了。第80、90、95百分位数同理。



![img](/img-post/开发/浏览器/浏览器性能performance及性能衡量方法.assets/v2-52a92c9bde37b242cd5af0f7dcc5e075_1440w.jpg)



与平均值统计方法不同，百分位数统计法会给到几个主要的百分位数的性能数据值，如25%、50%、75%的性能数据值，这样用户看到的是几个实际的性能数据，但对于整体的样本情况没有直观的认识；同时提供哪几个百分位数的性能数据及提供多少个不好确定，因为用户关注的内容不同，那么对于百分位数的要求也就不一样。

## 3.样本分布统计法

将性能样本数据进行分桶统计，为了防止桶的个数太多，并且不给实时统计带来很大压力，可以使用不均匀的桶进行统计。对于性能数据，大家会非常关注10s内的样本分布情况，对于10s之后的数据桶可以粗放设置。如图：

![img](/img-post/开发/浏览器/浏览器性能performance及性能衡量方法.assets/v2-6e6274981d29604f1f83b6abb9cac868_1440w.jpg)



其中[阿里云前端监控](https://link.zhihu.com/?target=https%3A//help.aliyun.com/document_detail/58652.html%3Fspm%3Da2c4g.11186623.6.577.283168b00dzbak)针对桶的划分如下：

**性能数据桶的大小**

![img](/img-post/开发/浏览器/浏览器性能performance及性能衡量方法.assets/v2-787ac21f42eebbab643b063ab27ad0ca_1440w.jpg)



通过样本分布统计法，可以给用户提供非常直观的样本性能分布情况。通过上面的分布图可以很直观的知道页面在指定时间区间内的样本占比，比如：可以快速知道页面能够在1s内打开的占比，即秒开率；长尾访问用户的样本占比。

其中阿里云前端监控采用平均值统计法+样本分布统计法组合为用户在性能方面提供更为全面的数据。

## 使用场景

前端监控中性能数据统计部分可以满足用户两个经典使用场景： 1. 定位页面性能问题 2. 性能迭代优化。

## 定位页面性能问题

由于平均值统计法最终统计的值会受到长尾数据的影响，从而会导致某一段时间内的平均值会有一个波动，所以定位页面性能问题的流程如下：

1. 先看页面平均值统计趋势图是否波动异常

![img](/img-post/开发/浏览器/浏览器性能performance及性能衡量方法.assets/v2-56963662005ef3279471bff9f2f19a9c_1440w.jpg)

会发现18点的数据波动较大

\2. 查找指定时间区间内性能样本分布情况 先看正常时间区间内性能样本分布:

![img](/img-post/开发/浏览器/浏览器性能performance及性能衡量方法.assets/v2-6cad928a9a0836c0340a2052be28145f_1440w.jpg)

样本量较少，页面完全加载时间都比较正常。 然后查看异常时间区间内样本分布：

![img](/img-post/开发/浏览器/浏览器性能performance及性能衡量方法.assets/v2-5fcb0660376f7cfa62ad2dc65df42130_1440w.jpg)

会发现有一个异常访问，导致计算均值时波动较大。说明整体页面性能在正常可控范围内。

\3. 发现异常后，可以通过访问明细，定位用户访问的基本环境，如：浏览器、设备、操作系统、地域及网络等情况。

通过均值统计法+样本分布统计法结合，可以具体知道页面性能的问题。

## 性能迭代优化

因为均值统计法会受到毛刺数据的影响，导致计算后的均值无法直接衡量性能的好坏。这时，就需要借助样本分布统计法来看性能优化的整体情况了。

这里介绍一个场景。比如：页面加载时间的优化会直接影响电商网站商品的成交量，那么在做性能优化时，我们会更看重在4s内页面加载时间的样本占比。那么我们会看优化前4s内样本占比与优化后的占比情况，如果占比大幅提高，那说明优化效果明显。

均值统计法与样本分布统计法结合，可以给用户提供非常多的信息，也希望通过本次介绍，能让用户将这些数据很好的利用，帮助业务快速成长。



https://zhuanlan.zhihu.com/p/44207458